<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Keyword.mappers.content.ContentMapper">
    <insert id="create">
        INSERT INTO disney_contents(
            imdb_id
            , title
            , plot
            , type
            , rated
            , year
            , released_at
            , runtime
            , director
            , writer
            , actor
            , subtitle
            , award_win
            , award_nominate
            , award_major
            , award_major_type
            , imdb_rating
            , imdb_votes
            , rating
            , review_cnt
        ) VALUES (
            #{contentId}
            , #{title}
            , #{plot}
            , #{type}
            , #{rated}
            , #{year}
            , #{releasedAt}
            , #{runtime}
            , #{director}
            , #{writer}
            , #{actor}
            , #{subtitle}
            , #{awardWin}
            , #{awardNominate}
            , #{awardMajor}
            , #{awardMajorType}
            , #{imdbRating}
            , #{imdbVotes}
            , #{rating}
            , #{reviewCnt}
        )
    </insert>

    <select id="read" resultMap="ContentResultMap">
        SELECT
            imdb_id
            , title
            , plot
            , type
            , rated
            , year
            , released_at
            , runtime
            , director
            , actor
            , award_win
            , award_nominate
            , award_major
            , award_major_type
            , imdb_rating
            , rating
            , review_cnt
        FROM    disney_contents
        WHERE   imdb_id = #{contentId}
    </select>

    <update id="update">
        UPDATE disney_contents
        SET
            title = #{title}
        WHERE imdb_id = #{contentId}
    </update>

    <delete id="delete">
        DELETE FROM disney_contents
        WHERE imdb_id = #{contentId}
    </delete>

    <select id="listAll" resultMap="ContentResultMap">
        <![CDATA[
        SELECT
            imdb_id
            , title
            , type
            , rated
            , year
            , released_at
            , runtime
            , director
            , actor
            , award_win
            , award_nominate
            , award_major
            , award_major_type
            , imdb_rating
            , review_cnt
        FROM    disney_contents
        ORDER BY title DESC
        ]]>
    </select>

    <!--
    <select id="listSelected" resultMap="ContentResultMap">
        <![CDATA[
        SELECT
            A.imdb_id
            , A.title
            , A.type
            , A.rated
            , A.year
            , A.released_at
            , A.runtime
            , A.director
            , A.actor
            , A.award_win
            , A.award_nominate
            , A.award_major
            , A.award_major_type
            , A.imdb_rating
            , A.review_cnt
            , B.genre
        FROM disney_contents A
        LEFT OUTER JOIN
            (SELECT
                imdb_id,
                genre
            FROM disney_genre
            <where>
                <if test = 'selGenre != ""'>
                    genre in
                    <foreach collection="selGenre" item="selGenre" open="(" close=")" separator=",">
                        #{selGenre[index]}
                    </foreach>
                </if>
            </where>
            ) B ON A.imdb_id = B.imdb_id
        <where>
                <if test='selType != ""'>
                    AND type = #{selType}
                </if>
                <if test = 'selRated != ""'>
                    AND (rated in
                        <foreach collection="selRated" item="selRated" open="(" close=")" separator=",">
                            #{selRated[index]}
                        </foreach>)
                </if>
                <if test='selRtime_start != -1 and selRtime_end != 1'>
                    AND (runtime >= #{selRtime_start}*60 AND runtime < #{selRtime_end}*60)
                </if>
        </where>
        ORDER BY A.released_at DESC
        ]]>
    </select>
    -->

    <select id="listType" resultType="string">
        <![CDATA[
            SELECT DISTINCT type
            FROM disney_contents
            WHERE type IS NOT NULL
            ORDER BY type ASC;
        ]]>
    </select>

    <select id="listGenre" resultType="string">
        <![CDATA[
            SELECT DISTINCT genre
            FROM disney_genre
            WHERE genre IS NOT NULL
            ORDER BY genre ASC;
        ]]>
    </select>

    <select id="listRated" resultType="string">
        <![CDATA[
            SELECT DISTINCT rated
            FROM disney_contents
            WHERE rated IS NOT NULL
            ORDER BY rated ASC;
        ]]>
    </select>

    <update id="updateReviewCnt">
        UPDATE disney_contents
        SET review_cnt = review_cnt + #{amount}
        WHERE imdb_id = #{contentId};
    </update>

    <resultMap id="ContentResultMap" type="ContentVO">
        <id property="contentId" column="imdb_id"/>
        <result property="title" column="title"/>
        <result property="type" column="type"/>
        <result property="rated" column="rated"/>
        <result property="year" column="year"/>
        <result property="releasedAt" column="released_at"/>
        <result property="runtime" column="runtime"/>
        <result property="director" column="director"/>
        <result property="actor" column="actor"/>
        <result property="awardWin" column="award_win"/>
        <result property="awardNominate" column="award_nominate"/>
        <result property="awardMajor" column="award_major"/>
        <result property="awardMajorType" column="award_major_type"/>
        <result property="imdbRating" column="imdb_rating"/>
        <result property="rating" column="rating"/>
        <result property="reviewCnt" column="review_cnt"/>
        <collection property="genres" javaType="java.util.ArrayList" resultMap="GenreResultMap"/>
    </resultMap>

    <resultMap id="GenreResultMap" type="GenreVO">
        <id property="contentId" column="imdb_id"/>
        <result property="genre" column="genre"/>
    </resultMap>


</mapper>